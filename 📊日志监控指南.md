# 后台日志监控指南

## 日志文件位置

```
mvp/logs/
├── app_2026-01-19.log      # 今天的应用日志（所有级别）
├── error_2026-01-19.log    # 今天的错误日志（ERROR级别）
├── app_2026-01-18.log      # 历史日志
└── ...
```

---

## 快速监控命令

### 方法1: 实时监控所有日志
```bash
# 在项目根目录执行
tail -f mvp/logs/app_2026-01-19.log
```

### 方法2: 只监控错误日志
```bash
tail -f mvp/logs/error_2026-01-19.log
```

### 方法3: 监控特定关键词
```bash
# 监控训练相关日志
tail -f mvp/logs/app_2026-01-19.log | grep -i "training\|epoch\|loss"

# 监控MPS设备使用
tail -f mvp/logs/app_2026-01-19.log | grep -i "mps\|device"

# 监控API请求
tail -f mvp/logs/app_2026-01-19.log | grep -i "api\|request"

# 监控错误
tail -f mvp/logs/app_2026-01-19.log | grep -i "error\|exception\|failed"
```

### 方法4: 使用脚本监控
```bash
# 使用提供的监控脚本
./监控日志.sh
```

---

## 日志级别说明

| 级别 | 说明 | 示例 |
|------|------|------|
| **DEBUG** | 调试信息 | 详细的执行流程 |
| **INFO** | 一般信息 | 服务启动、请求处理 |
| **WARNING** | 警告信息 | 非致命问题 |
| **ERROR** | 错误信息 | 操作失败 |
| **CRITICAL** | 严重错误 | 系统崩溃 |

---

## 常见日志模式

### 1. 服务启动
```
INFO | app.main:lifespan:53 - Application started: Bank Code Retrieval System v1.0.0
INFO | app.services.model_trainer:__init__:XXX - ModelTrainer initialized - Device: mps
INFO | app.services.query_service:__init__:XXX - QueryService initialized - Device: mps
```

### 2. 训练开始
```
INFO | app.api.training:start_training:XXX - Starting training job XX
INFO | app.services.model_trainer:train_model:XXX - Starting training for job XX
INFO | app.services.model_trainer:load_base_model:XXX - Loading base model: Qwen/Qwen2.5-0.5B
INFO | app.services.model_trainer:configure_lora:XXX - LoRA configured - Trainable params: XXX
```

### 3. 训练进度
```
INFO | app.services.model_trainer:on_epoch_end:XXX - Epoch 1/3 completed - Loss: 0.1234
INFO | app.services.model_trainer:on_epoch_end:XXX - Epoch 2/3 completed - Loss: 0.0987
INFO | app.services.model_trainer:on_epoch_end:XXX - Epoch 3/3 completed - Loss: 0.0765
```

### 4. 训练完成
```
INFO | app.services.model_trainer:train_model:XXX - Training completed for job XX
INFO | app.services.model_trainer:train_model:XXX - Model saved to: models/job_XX/final_model
```

### 5. 查询请求
```
INFO | app.api.query:query_bank_code:XXX - Processing query from user admin: 工商银行北京分行
INFO | app.services.query_service:query:XXX - Query completed - Response time: 234.5ms
```

### 6. 错误信息
```
ERROR | app.services.model_trainer:train_model:XXX - Training failed: [错误详情]
ERROR | app.api.query:query_bank_code:XXX - Query processing failed: [错误详情]
WARNING | app.core.exceptions:http_exception_handler:XXX - HTTP Exception [request_id]: 404 - Not Found
```

---

## 实用监控命令

### 查看最近的日志
```bash
# 查看最后50行
tail -50 mvp/logs/app_2026-01-19.log

# 查看最后100行
tail -100 mvp/logs/app_2026-01-19.log
```

### 搜索特定内容
```bash
# 搜索所有错误
grep -i "error" mvp/logs/app_2026-01-19.log

# 搜索训练相关
grep -i "training" mvp/logs/app_2026-01-19.log

# 搜索特定任务
grep "job 20" mvp/logs/app_2026-01-19.log

# 搜索MPS相关
grep -i "mps" mvp/logs/app_2026-01-19.log
```

### 统计信息
```bash
# 统计错误数量
grep -c "ERROR" mvp/logs/app_2026-01-19.log

# 统计警告数量
grep -c "WARNING" mvp/logs/app_2026-01-19.log

# 统计训练任务数量
grep -c "Starting training" mvp/logs/app_2026-01-19.log
```

### 按时间过滤
```bash
# 查看特定时间段的日志
grep "2026-01-19 20:" mvp/logs/app_2026-01-19.log

# 查看最近1小时的日志
grep "2026-01-19 20:" mvp/logs/app_2026-01-19.log | tail -100
```

---

## 高级监控技巧

### 1. 彩色输出
```bash
# 高亮显示错误（红色）
tail -f mvp/logs/app_2026-01-19.log | grep --color=always -E "ERROR|WARNING|$"

# 高亮显示多个关键词
tail -f mvp/logs/app_2026-01-19.log | grep --color=always -E "ERROR|WARNING|Training|completed|$"
```

### 2. 多文件监控
```bash
# 同时监控应用日志和错误日志
tail -f mvp/logs/app_2026-01-19.log mvp/logs/error_2026-01-19.log
```

### 3. 过滤噪音
```bash
# 排除某些日志
tail -f mvp/logs/app_2026-01-19.log | grep -v "health"

# 只看重要日志
tail -f mvp/logs/app_2026-01-19.log | grep -E "ERROR|WARNING|Training|completed"
```

### 4. 保存监控结果
```bash
# 将监控结果保存到文件
tail -f mvp/logs/app_2026-01-19.log | tee monitor_output.log

# 只保存错误到文件
tail -f mvp/logs/app_2026-01-19.log | grep "ERROR" >> errors_only.log
```

---

## 监控训练任务

### 完整的训练监控命令
```bash
# 监控训练进度、Loss、设备使用
tail -f mvp/logs/app_2026-01-19.log | grep -E "Training|Epoch|Loss|Device|MPS|completed|failed"
```

**预期输出**:
```
INFO | ModelTrainer initialized - Device: mps
INFO | Starting training for job 21
INFO | Loading base model: Qwen/Qwen2.5-0.5B
INFO | LoRA configured - Trainable params: 1,081,344 / 495,114,112 (0.22%)
INFO | Epoch 1/3 completed - Loss: 0.1234
INFO | Epoch 2/3 completed - Loss: 0.0987
INFO | Epoch 3/3 completed - Loss: 0.0765
INFO | Training completed for job 21
```

---

## 监控系统性能

### 1. 监控内存使用
```bash
# 查看内存相关日志
tail -f mvp/logs/app_2026-01-19.log | grep -i "memory\|cache"
```

### 2. 监控响应时间
```bash
# 查看API响应时间
tail -f mvp/logs/app_2026-01-19.log | grep "Response time"
```

### 3. 监控设备使用
```bash
# 查看设备信息
tail -f mvp/logs/app_2026-01-19.log | grep -i "device\|mps\|cuda\|cpu"
```

---

## 日志分析工具

### 1. 查看日志文件大小
```bash
ls -lh mvp/logs/
```

### 2. 查看日志行数
```bash
wc -l mvp/logs/app_2026-01-19.log
```

### 3. 查看日志时间范围
```bash
# 第一条日志
head -1 mvp/logs/app_2026-01-19.log

# 最后一条日志
tail -1 mvp/logs/app_2026-01-19.log
```

### 4. 生成日志摘要
```bash
# 错误摘要
echo "错误统计:"
grep -c "ERROR" mvp/logs/app_2026-01-19.log
echo ""
echo "警告统计:"
grep -c "WARNING" mvp/logs/app_2026-01-19.log
echo ""
echo "训练任务统计:"
grep -c "Training completed" mvp/logs/app_2026-01-19.log
```

---

## 常见问题排查

### 问题1: 找不到日志文件
```bash
# 检查日志目录
ls -la mvp/logs/

# 检查今天的日期
date +%Y-%m-%d

# 查找所有日志文件
find mvp/logs/ -name "*.log"
```

### 问题2: 日志文件太大
```bash
# 查看文件大小
du -h mvp/logs/app_2026-01-19.log

# 只查看最新的日志
tail -1000 mvp/logs/app_2026-01-19.log

# 清理旧日志（谨慎操作）
# rm mvp/logs/app_2026-01-*.log
```

### 问题3: 日志没有更新
```bash
# 检查后端服务是否运行
ps aux | grep uvicorn

# 检查日志文件权限
ls -l mvp/logs/app_2026-01-19.log

# 重启后端服务
pkill -f uvicorn
cd mvp && nohup ./venv/bin/python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 > /dev/null 2>&1 &
```

---

## 推荐监控方案

### 开发环境
```bash
# 终端1: 监控所有日志
tail -f mvp/logs/app_2026-01-19.log

# 终端2: 监控错误
tail -f mvp/logs/error_2026-01-19.log

# 终端3: 运行后端服务
cd mvp && ./venv/bin/python3 -m uvicorn app.main:app --reload
```

### 生产环境
```bash
# 使用后台运行 + 日志监控
cd mvp
nohup ./venv/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /dev/null 2>&1 &

# 监控关键日志
tail -f logs/app_2026-01-19.log | grep -E "ERROR|WARNING|Training|completed"
```

---

## 快速参考

### 最常用的命令
```bash
# 1. 实时监控
tail -f mvp/logs/app_2026-01-19.log

# 2. 监控错误
tail -f mvp/logs/error_2026-01-19.log

# 3. 监控训练
tail -f mvp/logs/app_2026-01-19.log | grep -i training

# 4. 查看最近日志
tail -50 mvp/logs/app_2026-01-19.log

# 5. 搜索错误
grep ERROR mvp/logs/app_2026-01-19.log
```

---

## 总结

**日志文件位置**: `mvp/logs/app_2026-01-19.log`

**推荐监控命令**:
```bash
# 基础监控
tail -f mvp/logs/app_2026-01-19.log

# 高级监控（带过滤）
tail -f mvp/logs/app_2026-01-19.log | grep -E "ERROR|WARNING|Training|MPS|Device"
```

**快捷脚本**:
```bash
./监控日志.sh
```

现在您可以实时监控后台运行情况了！
