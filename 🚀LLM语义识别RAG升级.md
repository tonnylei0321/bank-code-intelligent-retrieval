# 🚀 LLM语义识别RAG升级

## 💡 核心思想

你的建议非常棒！使用LLM进行语义识别比硬编码关键词更智能：

### 传统方案的问题
- **硬编码关键词**：无法穷举所有银行名称
- **简单匹配**：无法理解语义关系
- **维护困难**：新银行需要手动添加

### LLM语义识别的优势
- **智能理解**：理解银行名称的结构规律
- **自动提取**：提取银行名称、地理位置、支行名称
- **语义匹配**：理解"农行"="中国农业银行"等同义词
- **无需维护**：自动适应新的银行名称

## 🔧 实现方案

### 1. LLM实体提取器

**新增方法**：`extract_bank_entities_with_llm()`

```python
def extract_bank_entities_with_llm(self, question: str) -> Dict[str, str]:
    """
    使用LLM提取银行相关实体
    
    提示词示例：
    问题：农行厦门大同支行
    
    请提取以下信息：
    - bank_name: 银行名称（如：中国农业银行）
    - location: 地理位置（如：厦门）
    - branch_name: 支行名称（如：大同支行）
    - keywords: 用于搜索的关键词列表
    
    返回JSON格式
    """
```

### 2. 智能搜索策略

**升级的检索逻辑**：

1. **LLM实体提取**：
   ```
   输入："农行厦门大同支行"
   输出：{
     "bank_name": "中国农业银行",
     "location": "厦门", 
     "branch_name": "大同支行",
     "keywords": ["中国农业银行", "厦门", "大同", "支行"]
   }
   ```

2. **组合搜索**：
   ```sql
   -- 优先搜索组合关键词
   SELECT * FROM bank_codes 
   WHERE bank_name LIKE '%中国农业银行%厦门%'
   
   SELECT * FROM bank_codes 
   WHERE bank_name LIKE '%厦门%大同%'
   ```

3. **单词搜索**：
   ```sql
   -- 如果组合搜索结果不够，使用单个关键词
   SELECT * FROM bank_codes WHERE bank_name LIKE '%中国农业银行%'
   SELECT * FROM bank_codes WHERE bank_name LIKE '%厦门%'
   SELECT * FROM bank_codes WHERE bank_name LIKE '%大同%'
   ```

### 3. 银行名称规律识别

**LLM能理解的规律**：
- **完整格式**：`银行名称 + 省市 + 支行名称`
  - 中国农业银行股份有限公司厦门大同支行
- **简称格式**：`银行简称 + 地区 + 支行`
  - 农行厦门大同支行
- **同义词映射**：
  - 农行 → 中国农业银行
  - 工行 → 中国工商银行
  - 建行 → 中国建设银行

## 🎯 预期效果

### 测试用例1：完整名称
**输入**：`中国农业银行股份有限公司厦门大同支行`
**LLM提取**：
```json
{
  "bank_name": "中国农业银行",
  "location": "厦门",
  "branch_name": "大同支行", 
  "keywords": ["中国农业银行", "厦门", "大同", "支行"]
}
```
**搜索策略**：
1. `%中国农业银行%厦门%` → 找到目标银行
2. `%厦门%大同%` → 进一步确认

### 测试用例2：简称
**输入**：`农行厦门大同支行`
**LLM提取**：
```json
{
  "bank_name": "中国农业银行",
  "location": "厦门",
  "branch_name": "大同支行",
  "keywords": ["中国农业银行", "厦门", "大同", "支行"]
}
```

### 测试用例3：口语化
**输入**：`厦门大同的农行联行号`
**LLM提取**：
```json
{
  "bank_name": "中国农业银行",
  "location": "厦门",
  "branch_name": "大同",
  "keywords": ["中国农业银行", "厦门", "大同"]
}
```

## 🔧 技术实现

### 1. 提示工程
```python
prompt = f"""请从以下问题中提取银行相关信息，以JSON格式返回：

问题：{question}

请提取以下信息（如果存在）：
- bank_name: 银行名称（如：中国农业银行、工商银行、建设银行等）
- location: 地理位置（如：厦门、北京、上海等）
- branch_name: 支行名称（如：大同支行、知春路支行等）
- keywords: 用于搜索的关键词列表

返回JSON格式，例如：
{{"bank_name": "中国农业银行", "location": "厦门", "branch_name": "大同支行", "keywords": ["中国农业银行", "厦门", "大同", "支行"]}}

JSON:"""
```

### 2. 容错机制
- **JSON解析失败**：降级到简单关键词提取
- **模型未加载**：使用传统方法
- **生成异常**：返回原问题作为关键词

### 3. 搜索优化
- **组合搜索优先**：多关键词组合匹配
- **去重机制**：避免重复结果
- **相关性排序**：优先返回最匹配的结果

## 📊 性能优化

### 1. 缓存机制
```python
# 可以添加LRU缓存，避免重复的实体提取
from functools import lru_cache

@lru_cache(maxsize=100)
def extract_bank_entities_with_llm_cached(self, question: str):
    return self.extract_bank_entities_with_llm(question)
```

### 2. 批量处理
- 对于相似问题，可以批量提取实体
- 减少模型调用次数

### 3. 模型优化
- 使用更小的生成长度（128 tokens）
- 低温度生成（0.1）确保稳定性
- 快速推理模式

## 🧪 测试计划

### 立即测试
1. **重启后端** ✅
2. **测试问题**：`农行厦门大同支行`
3. **期望日志**：
   ```
   INFO - RAG: LLM extracted entities: {"bank_name": "中国农业银行", "location": "厦门", "branch_name": "大同支行", "keywords": ["中国农业银行", "厦门", "大同", "支行"]}
   INFO - RAG: Searching with combined pattern: %中国农业银行%厦门%
   INFO - RAG: Found 1 records for combined pattern
   INFO - RAG: Result 1: 中国农业银行股份有限公司厦门大同支行 -> 103393037005
   ```

### 扩展测试
- 工行北京知春路支行
- 建行上海分行
- 招行深圳分行
- 各种简称和口语化表达

## 🎊 优势总结

### 1. 智能化 ⭐⭐⭐⭐⭐
- 理解银行名称的语义结构
- 自动处理同义词和简称
- 适应各种表达方式

### 2. 可扩展性 ⭐⭐⭐⭐⭐
- 无需硬编码新银行名称
- 自动适应新的表达方式
- 支持多语言（如果需要）

### 3. 准确性 ⭐⭐⭐⭐⭐
- 基于语义理解，不是简单匹配
- 组合搜索策略提高召回率
- 去重和排序提高精确率

### 4. 维护性 ⭐⭐⭐⭐⭐
- 无需维护关键词词典
- 自动适应新的银行和表达
- 代码简洁，逻辑清晰

---

**升级时间**：2026-01-21 18:33
**状态**：✅ 已实现，后端已重启
**下一步**：测试LLM语义识别效果

现在请测试：`农行厦门大同支行` 或 `中国农业银行厦门大同支行`，看看LLM是否能正确提取实体并找到正确的联行号！🚀