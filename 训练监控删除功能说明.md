# 训练监控删除功能说明

## 当前状态

### ✅ 已实现的功能

1. **单个删除**
   - 点击"删除"按钮可以从页面移除训练任务
   - 有确认对话框
   - 不能删除正在运行或等待中的任务

2. **批量删除**
   - 支持选择多个任务
   - 批量删除按钮显示选中数量
   - 正在运行的任务自动禁用选择

3. **刷新功能**
   - 不会导致界面死掉
   - 从服务器重新加载数据

4. **停止功能**
   - 可以停止正在运行的训练任务

### ⚠️ 临时限制

由于后端API存在验证问题（`query.func` 验证错误），删除功能目前只能：
- **从页面上移除任务**（前端状态更新）
- **刷新页面后任务会重新出现**（因为数据库中仍然存在）

## 后端API问题

### 问题描述

所有DELETE和某些POST请求都返回以下错误：
```json
{
  "success": false,
  "error_code": "VALIDATION_ERROR",
  "error_message": "Request validation failed",
  "error_details": {
    "validation_errors": [
      {
        "field": "query.func",
        "message": "Field required",
        "type": "missing"
      }
    ]
  }
}
```

### 可能的原因

1. **全局依赖项冲突**：某个全局的依赖项或中间件要求所有请求都包含`query.func`参数
2. **FastAPI版本问题**：可能是FastAPI或Pydantic版本不兼容
3. **路由配置问题**：可能有全局的查询参数验证器

### 已尝试的解决方案

1. ✅ 移除`response_model`参数
2. ✅ 创建替代的POST端点（`/{job_id}/delete`）
3. ✅ 简化端点定义
4. ❌ 所有尝试都失败，问题仍然存在

## 如何修复

### 方案1：调试后端API（推荐）

1. **检查全局依赖项**
   ```bash
   # 搜索可能的全局查询参数
   grep -r "Query.*func" mvp/app/
   grep -r "query.func" mvp/app/
   ```

2. **检查中间件**
   ```python
   # 查看 mvp/app/main.py 中的中间件配置
   # 查看是否有全局的请求验证器
   ```

3. **检查FastAPI版本**
   ```bash
   pip list | grep fastapi
   pip list | grep pydantic
   ```

4. **临时禁用中间件**
   - 逐个禁用中间件，找出导致问题的中间件

### 方案2：使用数据库直接删除（临时）

创建一个管理脚本直接操作数据库：

```python
# delete_training_jobs.py
from app.core.database import SessionLocal
from app.models.training_job import TrainingJob
import shutil
from pathlib import Path

def delete_jobs(job_ids):
    db = SessionLocal()
    try:
        jobs = db.query(TrainingJob).filter(TrainingJob.id.in_(job_ids)).all()
        
        for job in jobs:
            # 删除模型文件
            if job.model_path:
                model_path = Path(job.model_path)
                if model_path.exists():
                    shutil.rmtree(model_path)
            
            # 删除数据库记录
            db.delete(job)
        
        db.commit()
        print(f"Successfully deleted {len(jobs)} jobs")
    except Exception as e:
        db.rollback()
        print(f"Error: {e}")
    finally:
        db.close()

if __name__ == "__main__":
    # 删除指定的任务ID
    job_ids = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 17]
    delete_jobs(job_ids)
```

运行脚本：
```bash
cd mvp
source venv/bin/activate  # 或 venv\Scripts\activate (Windows)
python delete_training_jobs.py
```

### 方案3：重构API端点

如果问题无法快速解决，可以考虑：
1. 创建一个新的API模块，不使用FastAPI的自动验证
2. 使用原始的HTTP请求处理
3. 绕过问题的验证层

## 用户使用指南

### 当前可用功能

1. **查看训练任务列表** ✅
2. **刷新数据** ✅
3. **停止正在运行的任务** ✅
4. **从页面移除任务**（临时）⚠️
   - 点击删除按钮
   - 任务从页面消失
   - 刷新后会重新出现

### 永久删除任务的方法

在后端API修复之前，可以使用以下方法：

1. **使用数据库管理工具**
   ```bash
   sqlite3 mvp/data/bank_code.db
   DELETE FROM training_jobs WHERE id IN (1,2,3,4,5);
   ```

2. **使用Python脚本**（见方案2）

3. **等待后端API修复**

## 技术债务

- [ ] 修复后端DELETE API的验证问题
- [ ] 实现真正的删除功能
- [ ] 添加删除操作的审计日志
- [ ] 添加批量操作的进度提示
- [ ] 优化错误处理和用户反馈

## 联系支持

如果需要帮助修复后端API问题，请提供：
1. FastAPI版本号
2. Pydantic版本号
3. 完整的错误日志
4. 中间件配置
