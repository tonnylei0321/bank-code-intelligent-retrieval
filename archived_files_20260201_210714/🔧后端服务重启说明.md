# 🔧 后端服务重启说明

## 问题原因

生成样本时报错 "Failed to generate QA pairs"，原因是：
- 代码已经修复，但后端服务还在运行旧代码
- 需要重启后端服务以加载新代码

## 解决方案

### 方法1: 使用重启脚本（推荐）

```bash
./restart_backend.sh
```

这个脚本会：
1. 停止现有的后端服务
2. 启动新的后端服务
3. 检查服务状态

### 方法2: 手动重启

#### 步骤1: 停止现有服务

```bash
# 查找uvicorn进程
ps aux | grep uvicorn

# 停止进程（替换<PID>为实际的进程ID）
kill <PID>

# 或者直接停止所有uvicorn进程
pkill -f "uvicorn app.main:app"
```

#### 步骤2: 启动新服务

```bash
cd mvp
source venv/bin/activate
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 方法3: 如果使用了start_mvp_backend.sh

```bash
# 停止服务
pkill -f "uvicorn app.main:app"

# 重新启动
./start_mvp_backend.sh
```

## 验证服务状态

### 检查服务是否运行

```bash
# 检查进程
ps aux | grep uvicorn

# 检查端口
lsof -i :8000

# 测试API
curl http://localhost:8000/health
```

### 查看日志

```bash
# 查看实时日志
tail -f mvp/logs/app_2026-02-01.log

# 或者查看backend.log（如果使用了重启脚本）
tail -f mvp/backend.log
```

## 修复内容

本次修复包括：

1. ✅ 修复了QAGenerator初始化参数错误
2. ✅ 增强了TeacherModelAPI的provider选择逻辑
3. ✅ 支持4种LLM提供商（qwen/deepseek/volces/local）
4. ✅ 实现了智能降级策略

## 重启后测试

重启服务后，请测试样本生成功能：

1. 登录系统
2. 进入"样本管理"页面
3. 点击"生成样本"按钮
4. 选择数据集和LLM提供商
5. 配置生成参数
6. 点击"开始生成样本"

如果仍然报错，请查看日志：
```bash
tail -100 mvp/logs/app_2026-02-01.log
```

## 常见问题

### Q: 重启后还是报错？
A: 检查是否有多个uvicorn进程在运行：
```bash
ps aux | grep uvicorn
# 停止所有
pkill -9 -f uvicorn
# 重新启动
cd mvp && source venv/bin/activate && python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### Q: 端口被占用？
A: 查找并停止占用8000端口的进程：
```bash
lsof -ti:8000 | xargs kill -9
```

### Q: 如何确认代码已更新？
A: 查看日志中的初始化信息，应该看到：
```
✅ 使用 QWEN API
✅ API密钥已配置（长度: 35）
```

## 联系支持

如果问题仍然存在，请提供：
1. 错误日志（最后100行）
2. 服务启动日志
3. 使用的LLM提供商
4. 生成参数配置

---

**文档更新时间**: 2026-02-01  
**适用版本**: v1.0.0
