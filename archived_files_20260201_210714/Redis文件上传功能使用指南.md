# Redis文件上传功能使用指南

## 🎯 功能概述

Redis管理页面现已支持手工上传银行数据文件，系统会自动解析文件内容并装载到Redis缓存中，提供快速的银行信息检索服务。

## 📁 支持的文件格式

### 文件类型
- `.unl` 文件（管道符分隔）
- `.txt` 文件（制表符分隔）  
- `.csv` 文件（逗号分隔）

### 数据格式要求
文件应包含以下三列数据：
1. **第1列**：联行编号（12位数字）
2. **第2列**：银行名称
3. **第3列**：清算行行号

**重要过滤规则**：
- 对于UNL格式文件，系统会检查每行的倒数第三个字段
- 只有倒数第三个字段等于"0"的记录才会被加载
- 倒数第三个字段不等于"0"的记录会被跳过，不做加载

### 示例数据格式

#### UNL格式（管道符分隔）
```
102290002916|中国工商银行股份有限公司上海市西虹桥支行|102290002916
102290002924|中国工商银行股份有限公司上海市徐汇支行|102290002924
102290002932|中国工商银行股份有限公司上海市黄浦支行|102290002932
```

#### CSV格式（逗号分隔）
```
102290002916,中国工商银行股份有限公司上海市西虹桥支行,102290002916
102290002924,中国工商银行股份有限公司上海市徐汇支行,102290002924
102290002932,中国工商银行股份有限公司上海市黄浦支行,102290002932
```

#### TXT格式（制表符分隔）
```
102290002916	中国工商银行股份有限公司上海市西虹桥支行	102290002916
102290002924	中国工商银行股份有限公司上海市徐汇支行	102290002924
102290002932	中国工商银行股份有限公司上海市黄浦支行	102290002932
```

## 🚀 使用步骤

### 1. 访问Redis管理页面
- 登录系统后，导航到 **Redis管理** 页面
- 确保您具有管理员权限

### 2. 上传文件
1. 在 **数据管理** 标签页中找到 **文件上传** 区域
2. 点击上传区域或拖拽文件到上传框
3. 选择符合格式要求的银行数据文件
4. 系统会自动开始处理文件

### 3. 查看处理结果
上传完成后，系统会显示：
- 文件名和大小
- 解析的记录数量
- 保存到数据库的记录数量
- Redis更新状态
- 处理耗时
- 示例数据预览

### 4. 验证数据
- 使用 **数据搜索** 功能测试上传的数据
- 查看 **统计信息** 标签页确认数据已加载到Redis

## 📊 功能特性

### 智能解析
- 自动检测文件编码（UTF-8、GBK、Latin-1）
- 自动识别分隔符类型
- 数据格式验证和清洗

### 批量处理
- 支持大文件批量处理（最大50MB）
- 分批加载到Redis，提高性能
- 实时显示处理进度

### 数据验证
- 联行编号格式验证（12位数字）
- 必填字段检查
- 重复数据处理

### 索引优化
- 自动创建银行名称索引
- 自动创建联行号索引
- 智能关键词索引生成

## 🔧 技术实现

### 后端处理流程
1. **文件接收**：FastAPI接收上传文件
2. **格式解析**：自动识别文件格式和编码
3. **数据验证**：验证联行号格式和必填字段
4. **数据库保存**：保存到SQLite数据库
5. **Redis加载**：批量加载到Redis缓存
6. **索引创建**：创建多种检索索引

### 前端交互
- 拖拽上传界面
- 实时处理状态显示
- 结果详情展示
- 错误信息提示

## 📝 使用注意事项

### 文件要求
- 文件大小不超过50MB
- 文件编码建议使用UTF-8
- 联行编号必须是12位数字
- 银行名称不能为空

### 权限要求
- 需要管理员权限才能上传文件
- 普通用户只能查看和搜索数据

### 性能考虑
- 大文件上传可能需要较长时间
- 建议在系统负载较低时进行大批量数据上传
- 上传过程中请勿关闭浏览器

## 🧪 测试功能

### 测试脚本
系统提供了测试脚本来验证上传功能：
```bash
cd mvp
python3 test_file_upload.py
```

### 示例文件
- `test_banks_sample.unl`：包含20条测试银行数据
- `data/T_BANK_LINE_NO_ICBC_ALL.unl`：完整银行数据文件

## 🔍 故障排除

### 常见问题

#### 1. 文件上传失败
- 检查文件格式是否正确
- 确认文件大小不超过50MB
- 验证用户权限

#### 2. 数据解析错误
- 检查文件编码格式
- 确认分隔符使用正确
- 验证联行编号格式

#### 3. Redis加载失败
- 检查Redis服务状态
- 确认Redis连接配置
- 查看系统日志

### 日志查看
```bash
# 查看应用日志
tail -f mvp/logs/app_$(date +%Y-%m-%d).log

# 查看错误日志
tail -f mvp/logs/error_$(date +%Y-%m-%d).log

# 查看后端日志
tail -f mvp/backend.log
```

## 🎉 功能优势

1. **用户友好**：拖拽上传，操作简单
2. **智能解析**：自动识别格式，无需手工配置
3. **高性能**：批量处理，快速加载
4. **数据完整性**：验证和清洗，确保数据质量
5. **实时反馈**：处理状态和结果实时显示
6. **多格式支持**：支持主流的数据文件格式

通过这个功能，您可以轻松地将银行数据文件上传到系统中，为智能问答系统提供丰富的数据支持。