# ✅ 三层样本管理结构实现完成

## 📋 功能概述

实现了三层结构的样本管理系统，支持"数据集 → 样本集 → 样本"的层级管理。一个数据集可以生成多个样本集，每个样本集包含多个样本。

**实现时间**: 2026-02-01

## 🏗️ 三层结构设计

```
数据集 (Dataset)
  ├── 样本集1 (Sample Set 1) - 第一次生成任务
  │   ├── 样本1 (Sample 1)
  │   ├── 样本2 (Sample 2)
  │   └── ...
  ├── 样本集2 (Sample Set 2) - 第二次生成任务
  │   ├── 样本1 (Sample 1)
  │   ├── 样本2 (Sample 2)
  │   └── ...
  └── ...
```

### 核心概念

1. **数据集 (Dataset)**: 上传的原始银行代码数据文件
2. **样本集 (Sample Set)**: 一次样本生成任务产生的所有样本的集合
3. **样本 (Sample/QA Pair)**: 具体的问答对，用于模型训练

### 关系说明

- 一个数据集可以生成**多个样本集**
- 每个样本集对应**一次生成任务**
- 每个样本集包含**多个样本**
- 样本集之间**相互独立**，可以单独管理和删除

## ✨ 核心功能

### 1. 数据库模型

#### SampleSet模型 (`mvp/app/models/sample_set.py`)

```python
class SampleSet(Base):
    id: int                      # 主键
    name: str                    # 样本集名称
    dataset_id: int              # 所属数据集ID
    generation_task_id: str      # 生成任务ID
    description: str             # 描述
    total_samples: int           # 总样本数
    train_samples: int           # 训练集样本数
    val_samples: int             # 验证集样本数
    test_samples: int            # 测试集样本数
    generation_config: dict      # 生成配置(JSON)
    status: str                  # 状态(generating/completed/failed)
    created_by: int              # 创建用户ID
    created_at: datetime         # 创建时间
    completed_at: datetime       # 完成时间
```

#### QAPair模型更新

添加了`sample_set_id`字段，关联到样本集：
```python
class QAPair(Base):
    id: int
    dataset_id: int              # 所属数据集
    sample_set_id: int           # 所属样本集 (新增)
    source_record_id: int
    question: str
    answer: str
    question_type: str
    split_type: str
    generated_at: datetime
```

### 2. API端点

#### 样本集管理API (`mvp/app/api/sample_sets.py`)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/sample-sets/dataset/{dataset_id}` | GET | 获取数据集的所有样本集 |
| `/api/v1/sample-sets/{sample_set_id}` | GET | 获取样本集详情 |
| `/api/v1/sample-sets` | POST | 创建样本集 |
| `/api/v1/sample-sets/{sample_set_id}` | PUT | 更新样本集 |
| `/api/v1/sample-sets/{sample_set_id}` | DELETE | 删除样本集 |
| `/api/v1/sample-sets/batch-delete` | POST | 批量删除样本集 |
| `/api/v1/sample-sets/{sample_set_id}/samples` | GET | 获取样本集的样本列表 |
| `/api/v1/sample-sets/{sample_set_id}/stats` | GET | 获取样本集统计信息 |

### 3. 前端页面

#### 新版样本管理页面 (`frontend/src/pages/SampleManagementNew.tsx`)

**三个视图模式**:

1. **数据集选择视图** (`dataset`)
   - 显示所有数据集
   - 选择数据集进入样本集列表

2. **样本集列表视图** (`sample-sets`)
   - 显示选定数据集的所有样本集
   - 支持批量删除样本集
   - 可以生成新的样本集
   - 点击样本集查看具体样本

3. **样本列表视图** (`samples`)
   - 显示选定样本集的所有样本
   - 支持批量删除样本
   - 查看样本详情

## 📊 用户操作流程

### 流程1: 查看样本

```
1. 进入样本管理页面
   ↓
2. 选择数据集
   ↓
3. 查看该数据集的样本集列表
   ↓
4. 点击某个样本集
   ↓
5. 查看该样本集的具体样本
```

### 流程2: 生成新样本集

```
1. 进入样本管理页面
   ↓
2. 选择数据集
   ↓
3. 点击"生成样本"按钮
   ↓
4. 配置生成参数
   ↓
5. 开始生成（异步任务）
   ↓
6. 自动创建新的样本集
   ↓
7. 样本关联到新样本集
```

### 流程3: 删除样本集

```
1. 进入样本管理页面
   ↓
2. 选择数据集
   ↓
3. 查看样本集列表
   ↓
4. 选择要删除的样本集
   ↓
5. 点击"删除"或"批量删除"
   ↓
6. 确认删除
   ↓
7. 样本集及其所有样本被删除
```

## 🎯 界面设计

### 数据集选择视图

```
┌─────────────────────────────────────────────┐
│  样本管理                                    │
│  数据集                                      │
├─────────────────────────────────────────────┤
│                                             │
│  选择数据集                                  │
│  请选择一个数据集以查看其样本集              │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │ 🔽 请选择数据集                      │   │
│  │   T_BANK_LINE_NO_ICBC_ALL.unl       │   │
│  │   (1000 条记录)                      │   │
│  └─────────────────────────────────────┘   │
│                                             │
└─────────────────────────────────────────────┘
```

### 样本集列表视图

```
┌─────────────────────────────────────────────┐
│  样本管理                    [生成样本]      │
│  数据集 > T_BANK_LINE_NO_ICBC_ALL.unl       │
├─────────────────────────────────────────────┤
│  📊 统计信息                                 │
│  ┌──────┬──────┬──────┬──────┐            │
│  │样本集│总样本│已完成│生成中│            │
│  │  3   │ 2850 │  2   │  1   │            │
│  └──────┴──────┴──────┴──────┘            │
│                                             │
│  样本集列表              [返回] [刷新]      │
│  ┌─────────────────────────────────────┐   │
│  │☑ 名称          │样本数│状态│创建时间│   │
│  ├─────────────────────────────────────┤   │
│  │□ 样本集1-20240101│ 950 │✓完成│...   │   │
│  │□ 样本集2-20240102│ 900 │✓完成│...   │   │
│  │□ 样本集3-20240103│1000 │⏳中 │...   │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

### 样本列表视图

```
┌─────────────────────────────────────────────┐
│  样本管理                                    │
│  数据集 > T_BANK... > 样本集1-20240101      │
├─────────────────────────────────────────────┤
│  📊 样本集信息                               │
│  ┌──────┬──────┬──────┬──────┐            │
│  │总样本│训练集│验证集│测试集│            │
│  │ 950  │ 760  │  95  │  95  │            │
│  └──────┴──────┴──────┴──────┘            │
│                                             │
│  样本列表          [返回样本集] [刷新]      │
│  ┌─────────────────────────────────────┐   │
│  │☑ ID│问题      │类型│划分│时间│操作│   │
│  ├─────────────────────────────────────┤   │
│  │□ 1 │工商银行...│精确│训练│... │查看│   │
│  │□ 2 │工行的...  │模糊│训练│... │查看│   │
│  │□ 3 │102100... │反向│验证│... │查看│   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

## 🔄 异步生成集成

### 生成任务创建样本集

当用户启动样本生成任务时：

1. **创建样本集记录**
```python
sample_set = SampleSet(
    name=f"{dataset.filename} - {timestamp}",
    dataset_id=dataset_id,
    generation_task_id=task_id,
    status="generating",
    created_by=user_id
)
```

2. **生成样本并关联**
```python
for record in records:
    qa_pair = generate_qa_pair(record)
    qa_pair.sample_set_id = sample_set.id  # 关联到样本集
    db.add(qa_pair)
```

3. **更新样本集统计**
```python
sample_set.total_samples = successful_count
sample_set.train_samples = train_count
sample_set.val_samples = val_count
sample_set.test_samples = test_count
sample_set.status = "completed"
sample_set.completed_at = datetime.now()
```

## 📝 数据库迁移

### 迁移脚本 (`mvp/migrate_add_sample_sets.py`)

执行以下操作：

1. 创建`sample_sets`表
2. 为`qa_pairs`表添加`sample_set_id`列
3. 创建必要的索引
4. 验证迁移结果

**运行迁移**:
```bash
cd mvp
python migrate_add_sample_sets.py
```

## 🎨 界面特性

### 1. 面包屑导航

```
数据集 > T_BANK_LINE_NO_ICBC_ALL.unl > 样本集1-20240101
```

- 点击任意层级可以返回
- 清晰显示当前位置

### 2. 统计卡片

在样本集列表视图显示：
- 样本集数量
- 总样本数
- 已完成数量
- 生成中数量

在样本列表视图显示：
- 总样本数
- 训练集数量
- 验证集数量
- 测试集数量

### 3. 批量操作

- 支持多选样本集
- 支持多选样本
- 批量删除功能
- 显示选中数量

### 4. 状态标识

样本集状态：
- 🔵 生成中 (generating)
- ✅ 已完成 (completed)
- ❌ 失败 (failed)

## 💡 使用场景

### 场景1: 对比不同生成策略

```
数据集: bank_codes.unl
├── 样本集1: 使用Qwen生成 (1000个样本)
├── 样本集2: 使用DeepSeek生成 (1000个样本)
└── 样本集3: 使用本地模板生成 (1000个样本)

→ 可以对比不同LLM的生成质量
```

### 场景2: 增量生成

```
数据集: bank_codes.unl
├── 样本集1: 初始生成 (800个样本)
├── 样本集2: 补充生成 (200个样本)
└── 样本集3: 特定类型生成 (500个样本)

→ 逐步扩充训练数据
```

### 场景3: 版本管理

```
数据集: bank_codes.unl
├── 样本集1: v1.0 - 2024-01-01 (1000个样本)
├── 样本集2: v1.1 - 2024-01-15 (1200个样本)
└── 样本集3: v2.0 - 2024-02-01 (1500个样本)

→ 保留历史版本，方便回滚
```

## ⚠️ 注意事项

### 1. 级联删除

删除样本集时会**级联删除**其所有样本：
```python
# 删除样本集
db.delete(sample_set)
# 自动删除所有关联的样本
# sample_set.qa_pairs 会被级联删除
```

### 2. 数据隔离

每个样本集的样本是**独立的**：
- 不同样本集的样本不会混淆
- 可以单独导出某个样本集
- 可以单独删除某个样本集

### 3. 统计信息

样本集的统计信息需要**及时更新**：
- 生成完成时更新
- 手动删除样本时需要重新计算

## 🚀 后续优化建议

### 1. 样本集合并

支持将多个样本集合并为一个：
```python
POST /api/v1/sample-sets/merge
{
  "source_sample_set_ids": [1, 2, 3],
  "target_name": "合并后的样本集"
}
```

### 2. 样本集导出

支持导出特定样本集：
```python
GET /api/v1/sample-sets/{sample_set_id}/export
→ 下载JSON/CSV格式的样本数据
```

### 3. 样本集对比

对比不同样本集的质量：
```python
GET /api/v1/sample-sets/compare?ids=1,2,3
→ 返回质量对比报告
```

### 4. 样本集标签

为样本集添加标签功能：
```python
sample_set.tags = ["qwen", "high-quality", "v1.0"]
```

## 📂 相关文件

### 后端文件
- `mvp/app/models/sample_set.py` - 样本集模型（新增）
- `mvp/app/models/qa_pair.py` - QA Pair模型（更新）
- `mvp/app/models/dataset.py` - Dataset模型（更新）
- `mvp/app/api/sample_sets.py` - 样本集API（新增）
- `mvp/app/api/sample_generation_async.py` - 异步生成API（更新）
- `mvp/migrate_add_sample_sets.py` - 数据库迁移脚本（新增）

### 前端文件
- `frontend/src/pages/SampleManagementNew.tsx` - 新版样本管理页面（新增）
- `frontend/src/App.tsx` - 路由配置（更新）

## ✅ 测试步骤

### 1. 运行数据库迁移

```bash
cd mvp
python migrate_add_sample_sets.py
```

### 2. 重启后端服务

```bash
cd mvp
python -m uvicorn app.main:app --reload
```

### 3. 刷新前端

```
Command + Shift + R (Mac)
Ctrl + Shift + R (Windows)
```

### 4. 测试流程

1. 进入"样本管理"页面
2. 选择一个数据集
3. 查看样本集列表（如果没有，先生成）
4. 点击"生成样本"创建新样本集
5. 等待生成完成
6. 查看新创建的样本集
7. 点击样本集查看具体样本
8. 测试批量删除功能

## 🎉 总结

成功实现了三层样本管理结构，主要改进：

1. **清晰的层级关系**: 数据集 → 样本集 → 样本
2. **独立管理**: 每个样本集可以独立管理和删除
3. **版本控制**: 支持同一数据集的多个样本集版本
4. **批量操作**: 支持批量删除样本集和样本
5. **统计信息**: 实时显示各层级的统计数据

这个设计使得样本管理更加灵活和强大，支持多种使用场景。

---

**实现时间**: 2026-02-01  
**状态**: ✅ 完成，等待测试验证
