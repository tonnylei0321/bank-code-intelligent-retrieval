# 🧪 训练任务测试指南

## 测试目标

验证数据集验证后自动生成QA对，确保训练任务可以正常创建。

## 前置条件

- ✅ 后端服务运行中（端口8000）
- ✅ 前端服务运行中（端口3000）
- ✅ 已登录系统（testuser 或 admin）

## 测试步骤

### 步骤1：上传数据集

1. 访问：http://localhost:3000/data
2. 点击"上传数据集"按钮
3. 选择CSV文件（包含联行号数据）
4. 点击"上传"
5. **预期结果**：上传成功，数据集出现在列表中

### 步骤2：验证数据集

1. 在数据集列表中找到刚上传的数据集
2. 点击"验证"按钮
3. 等待验证完成（可能需要几分钟，因为会自动生成QA对）
4. **预期结果**：
   - 验证成功提示
   - 数据集状态变为"validated"
   - 后台日志显示QA对生成信息

### 步骤3：检查QA对（可选）

通过API检查QA对是否生成：

```bash
# 获取QA对统计信息
curl -X GET "http://localhost:8000/api/v1/qa-pairs/{dataset_id}/stats" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 预期响应
{
  "dataset_id": 2,
  "total_pairs": 4000,
  "train_pairs": 3200,
  "val_pairs": 400,
  "test_pairs": 400,
  "exact_pairs": 1000,
  "fuzzy_pairs": 1000,
  "reverse_pairs": 1000,
  "natural_pairs": 1000
}
```

### 步骤4：创建训练任务

1. 访问：http://localhost:3000/training
2. 点击"创建训练任务"按钮
3. 选择刚才验证的数据集
4. 配置训练参数：
   - 模型名称：Qwen/Qwen2.5-0.5B
   - 训练轮数：3
   - 批次大小：8
   - 学习率：2e-4
5. 点击"开始训练"
6. **预期结果**：
   - ✅ 训练任务创建成功
   - ✅ 不再出现"Dataset has no QA pairs"错误
   - ✅ 训练任务开始执行

### 步骤5：监控训练进度

1. 在训练管理页面查看任务状态
2. 观察训练进度和指标
3. **预期结果**：
   - 状态从"pending"变为"running"
   - 进度百分比逐渐增加
   - 显示训练损失等指标

## 验证点

### ✅ 验证点1：QA对自动生成
- 验证数据集后，系统自动生成QA对
- 不需要用户手动操作

### ✅ 验证点2：训练任务创建成功
- 选择已验证的数据集
- 不再出现"no QA pairs"错误
- 训练任务正常启动

### ✅ 验证点3：数据集划分正确
- 80% 训练集
- 10% 验证集
- 10% 测试集

### ✅ 验证点4：问题类型完整
- exact（精确匹配）
- fuzzy（模糊匹配）
- reverse（反向查询）
- natural（自然语言）

## 错误场景测试

### 场景1：大模型API不可用

**测试步骤**：
1. 停止大模型API服务
2. 上传并验证数据集
3. **预期结果**：
   - 验证成功（不受影响）
   - 警告信息：QA pair generation failed
   - 训练任务创建失败（因为没有QA对）

### 场景2：重复验证

**测试步骤**：
1. 验证一个数据集（第一次）
2. 再次点击"验证"按钮（第二次）
3. **预期结果**：
   - 清空旧的QA对
   - 重新生成新的QA对
   - 不出现唯一约束冲突

## 日志检查

### 后端日志位置
```bash
# 查看后端日志
tail -f mvp/logs/app.log

# 或者查看终端输出
# 后端运行在终端中，直接查看输出
```

### 关键日志信息

**验证成功**：
```
INFO: Dataset 2 validated: 1000/1000 valid records
INFO: Starting automatic QA pair generation for dataset 2
```

**QA生成成功**：
```
INFO: QA pairs generated for dataset 2 - Total: 4000, Train: 3200, Val: 400, Test: 400
```

**训练任务创建**：
```
INFO: Training job 1 created by user 1
```

## 性能基准

### 预期时间
- 上传数据集：< 5秒
- 验证数据集（1000条记录）：5-10分钟
  - 数据验证：< 1分钟
  - QA对生成：4-9分钟（取决于大模型API速度）
- 创建训练任务：< 1秒

### 资源使用
- CPU：中等（QA生成期间）
- 内存：< 500MB
- 磁盘：每1000条记录约10MB（QA对数据）

## 故障排除

### 问题1：验证很慢
**原因**：QA对生成需要调用大模型API
**解决**：耐心等待，或检查大模型API是否正常

### 问题2：训练任务仍然失败
**检查**：
```bash
# 检查QA对是否生成
curl -X GET "http://localhost:8000/api/v1/qa-pairs/{dataset_id}/stats" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**解决**：
- 如果QA对数量为0，手动生成QA对
- 检查后端日志查看错误信息

### 问题3：QA对生成失败
**检查**：
- 大模型API是否可用
- 数据集是否有有效记录
- 后端日志中的错误信息

**解决**：
- 确保大模型API正常运行
- 重新验证数据集
- 或手动调用QA生成API

## 测试完成标准

- ✅ 数据集上传成功
- ✅ 数据集验证成功
- ✅ QA对自动生成（4种类型）
- ✅ 数据集正确划分（train/val/test）
- ✅ 训练任务创建成功
- ✅ 训练任务正常运行

## 相关文档

- [✅训练任务QA对自动生成.md](✅训练任务QA对自动生成.md) - 修复说明
- [🎯完整系统使用指南.md](🎯完整系统使用指南.md) - 系统使用指南
- [✅最终验证指南.md](✅最终验证指南.md) - 验证指南

## 测试日期

2026-01-12

## 测试状态

⏳ 待测试
