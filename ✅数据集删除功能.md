# ✅ 数据集删除功能

**添加时间**: 2026-01-12 16:45  
**功能**: 在数据管理页面添加删除按钮，允许用户删除数据集  
**状态**: ✅ 已完成

---

## 🎯 功能说明

### 新增功能
在数据管理页面的每个数据集行添加"删除"按钮，允许用户删除不需要的数据集。

### 删除内容
删除数据集时会同时删除：
1. ✅ 数据集记录（datasets表）
2. ✅ 所有关联的联行号记录（bank_codes表）
3. ✅ 上传的CSV文件（uploads目录）

### 安全措施
- ⚠️ 删除前会弹出确认对话框
- ⚠️ 删除操作不可恢复
- ✅ 删除成功后自动刷新列表

---

## 🔧 实现内容

### 1. 后端API

**文件**: `mvp/app/api/datasets.py`

**新增端点**：
```python
@router.delete("/{dataset_id}")
async def delete_dataset(
    dataset_id: int,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """删除数据集及其所有关联记录"""
    # 1. 查找数据集
    dataset = db.query(Dataset).filter(Dataset.id == dataset_id).first()
    
    # 2. 删除关联的联行号记录
    db.query(BankCode).filter(BankCode.dataset_id == dataset_id).delete()
    
    # 3. 删除文件
    if os.path.exists(dataset.file_path):
        os.remove(dataset.file_path)
    
    # 4. 删除数据集记录
    db.delete(dataset)
    db.commit()
    
    return {"message": "Dataset deleted successfully"}
```

**权限**：
- 所有已认证用户都可以删除数据集
- 不需要管理员权限

### 2. 前端API服务

**文件**: `frontend/src/services/api.ts`

**新增方法**：
```typescript
export const dataAPI = {
  // ... 其他方法
  
  /** 删除数据集 */
  deleteDataset: (id: number) => apiClient.delete(`/v1/datasets/${id}`),
};
```

### 3. 前端页面

**文件**: `frontend/src/pages/DataManagement.tsx`

#### 3.1 添加删除处理函数
```typescript
// 删除数据集
const handleDelete = (dataset: Dataset) => {
  Modal.confirm({
    title: '确认删除',
    content: `确定要删除数据集 "${dataset.filename}" 吗？此操作不可恢复。`,
    okText: '删除',
    okType: 'danger',
    cancelText: '取消',
    onOk: async () => {
      try {
        await dataAPI.deleteDataset(dataset.id);
        message.success('数据集已删除');
        fetchDatasets();
      } catch (error: any) {
        message.error(error.response?.data?.error_message || '删除失败');
      }
    },
  });
};
```

#### 3.2 添加删除按钮
```typescript
{
  title: '操作',
  key: 'action',
  render: (_: any, record: Dataset) => (
    <Space>
      <Button icon={<EyeOutlined />} onClick={() => handleViewDetail(record)}>
        详情
      </Button>
      <Button icon={<FileTextOutlined />} onClick={() => handlePreview(record)}>
        预览
      </Button>
      {!record.validated && (
        <Button icon={<CheckCircleOutlined />} onClick={() => handleValidate(record)}>
          验证
        </Button>
      )}
      <Button 
        danger 
        icon={<DeleteOutlined />} 
        onClick={() => handleDelete(record)}
      >
        删除
      </Button>
    </Space>
  ),
}
```

#### 3.3 添加图标导入
```typescript
import {
  UploadOutlined,
  EyeOutlined,
  CheckCircleOutlined,
  FileTextOutlined,
  ReloadOutlined,
  DeleteOutlined,  // ✅ 新增
} from '@ant-design/icons';
```

---

## 🧪 使用方法

### 删除单个数据集

1. **进入数据管理页面**
   - 点击左侧菜单"数据管理"

2. **找到要删除的数据集**
   - 在列表中找到目标数据集

3. **点击删除按钮**
   - 点击该行最右侧的红色"删除"按钮

4. **确认删除**
   - 弹出确认对话框
   - 显示：`确定要删除数据集 "文件名.csv" 吗？此操作不可恢复。`
   - 点击"删除"按钮确认
   - 或点击"取消"按钮取消操作

5. **查看结果**
   - ✅ 删除成功：显示"数据集已删除"提示
   - ✅ 列表自动刷新
   - ✅ 该数据集从列表中消失

### 批量删除（逐个删除）

如果要删除多个数据集：
1. 逐个点击删除按钮
2. 每次确认删除
3. 等待删除完成后再删除下一个

---

## ⚠️ 注意事项

### 删除前的考虑

1. **数据备份**
   - 删除操作不可恢复
   - 如果需要保留数据，请先备份CSV文件

2. **关联数据**
   - 删除数据集会同时删除所有关联的联行号记录
   - 如果有训练任务使用了该数据集，可能会影响训练结果

3. **文件删除**
   - 上传的CSV文件也会被删除
   - 如果需要重新使用，需要重新上传

### 删除失败的情况

如果删除失败，可能的原因：
1. **权限不足**：未登录或token过期
2. **数据集不存在**：已被其他用户删除
3. **文件被占用**：文件正在被其他进程使用
4. **数据库错误**：数据库连接问题

**解决方法**：
- 刷新页面重试
- 重新登录
- 查看后端日志

---

## 🔍 验证步骤

### 1. 刷新浏览器
- 按Ctrl+F5（Windows/Linux）或Cmd+Shift+R（Mac）
- 确保加载最新的前端代码

### 2. 进入数据管理页面
- 点击左侧菜单"数据管理"
- 查看数据集列表

### 3. 测试删除功能
1. **查看删除按钮**
   - ✅ 每行最右侧应该有红色的"删除"按钮

2. **点击删除按钮**
   - ✅ 弹出确认对话框
   - ✅ 显示数据集文件名
   - ✅ 有"删除"和"取消"两个按钮

3. **测试取消**
   - 点击"取消"按钮
   - ✅ 对话框关闭
   - ✅ 数据集仍在列表中

4. **测试删除**
   - 再次点击"删除"按钮
   - 点击"删除"确认
   - ✅ 显示"数据集已删除"提示
   - ✅ 列表自动刷新
   - ✅ 该数据集从列表中消失

### 4. 验证数据库
```bash
cd mvp
sqlite3 data/bank_code.db "SELECT COUNT(*) FROM datasets;"
sqlite3 data/bank_code.db "SELECT COUNT(*) FROM bank_codes;"
```

---

## 📊 界面预览

### 删除按钮位置
```
数据管理
┌─────────────────────────────────────────────────────────────┐
│ ID │ 文件名 │ 记录数 │ 状态 │ 已验证 │ 上传时间 │ 操作      │
├─────────────────────────────────────────────────────────────┤
│ 8  │ data.csv│ 1000  │ validated │ 是 │ 2026-01-12 │         │
│    │         │       │           │    │            │ 详情 预览│
│    │         │       │           │    │            │ 删除 ⬅️  │
└─────────────────────────────────────────────────────────────┘
```

### 确认对话框
```
┌─────────────────────────────────┐
│ 确认删除                         │
├─────────────────────────────────┤
│ 确定要删除数据集 "data.csv" 吗？  │
│ 此操作不可恢复。                  │
│                                 │
│         [取消]  [删除]           │
└─────────────────────────────────┘
```

---

## 🎯 使用场景

### 场景1：清理测试数据
在测试过程中上传了多个测试文件，现在需要清理：
1. 逐个删除测试数据集
2. 保留正式的数据集

### 场景2：删除错误数据
上传了错误的CSV文件，需要删除后重新上传：
1. 删除错误的数据集
2. 重新上传正确的文件

### 场景3：释放存储空间
数据集过多，需要删除旧的或不再使用的数据集：
1. 查看数据集列表
2. 删除不需要的数据集
3. 释放磁盘空间

### 场景4：重新开始
想要清空所有数据，重新开始：
1. 逐个删除所有数据集
2. 或使用清理脚本批量删除

---

## 🔧 后续优化建议

### 1. 批量删除
添加批量删除功能：
```typescript
// 选择多个数据集
const [selectedRows, setSelectedRows] = useState<number[]>([]);

// 批量删除
const handleBatchDelete = () => {
  Modal.confirm({
    title: '批量删除',
    content: `确定要删除选中的 ${selectedRows.length} 个数据集吗？`,
    onOk: async () => {
      for (const id of selectedRows) {
        await dataAPI.deleteDataset(id);
      }
      message.success('批量删除成功');
      fetchDatasets();
    },
  });
};
```

### 2. 软删除
实现软删除（标记为已删除，不真正删除）：
```python
# 添加deleted字段
dataset.deleted = True
dataset.deleted_at = datetime.now()
db.commit()
```

### 3. 回收站
添加回收站功能，允许恢复已删除的数据集：
- 删除时移动到回收站
- 30天后自动永久删除
- 可以从回收站恢复

### 4. 删除权限控制
只允许上传者或管理员删除：
```python
if dataset.uploaded_by != current_user.id and current_user.role != 'admin':
    raise HTTPException(403, "No permission to delete this dataset")
```

---

## 🎉 功能完成

数据集删除功能已完成！

**新增内容**：
- ✅ 后端删除API端点
- ✅ 前端删除按钮
- ✅ 确认对话框
- ✅ 删除关联数据
- ✅ 删除文件
- ✅ 错误处理

**验证方法**：
1. 刷新浏览器（Ctrl+F5）
2. 进入数据管理页面
3. 点击任意数据集的"删除"按钮
4. 确认删除
5. 验证数据集已从列表中消失

**使用建议**：
- 删除前确认不再需要该数据集
- 重要数据请先备份
- 删除操作不可恢复

---

**添加时间**: 2026-01-12 16:45  
**修改文件**: 
- mvp/app/api/datasets.py
- frontend/src/services/api.ts
- frontend/src/pages/DataManagement.tsx  
**服务状态**: 🟢 后端已自动重载，前端需刷新  
**验证状态**: ✅ 待用户验证

