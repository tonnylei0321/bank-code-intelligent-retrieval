# 🚀 三层样本管理测试指南

## 📋 测试前准备

### 1. 运行数据库迁移

```bash
cd mvp
python migrate_add_sample_sets.py
```

**预期输出**:
```
开始数据库迁移：添加样本集表
创建sample_sets表...
创建索引...
为qa_pairs表添加sample_set_id列...
✅ 数据库迁移完成！
验证迁移结果...
✓ sample_sets表创建成功
✓ qa_pairs.sample_set_id列添加成功
```

### 2. 重启后端服务

```bash
cd mvp
python -m uvicorn app.main:app --reload
```

### 3. 刷新前端浏览器

**Mac**: `Command + Shift + R`  
**Windows/Linux**: `Ctrl + Shift + R`

## 🧪 测试流程

### 测试1: 查看数据集选择界面

1. 登录系统（admin/admin123）
2. 点击左侧菜单"样本管理"
3. 应该看到数据集选择界面
4. 下拉框显示所有可用数据集

**验证点**:
- ✅ 页面标题显示"样本管理"
- ✅ 面包屑显示"数据集"
- ✅ 下拉框列出所有数据集
- ✅ 显示每个数据集的记录数

### 测试2: 查看样本集列表

1. 从下拉框选择一个数据集
2. 自动跳转到样本集列表视图
3. 查看该数据集的所有样本集

**验证点**:
- ✅ 面包屑显示"数据集 > [数据集名称]"
- ✅ 显示统计卡片（样本集数量、总样本数等）
- ✅ 表格显示样本集列表
- ✅ 每个样本集显示名称、样本数、状态、创建时间
- ✅ 有"生成样本"按钮
- ✅ 有"返回"和"刷新"按钮

### 测试3: 生成新样本集

1. 在样本集列表视图，点击"生成样本"按钮
2. 配置生成参数：
   - 选择数据集（已自动选中）
   - 选择LLM提供商：local（测试用）
   - 选择问题类型：exact, fuzzy
   - 记录数策略：自定义数量 10
3. 点击"开始生成样本"
4. 自动跳转到"生成任务"Tab
5. 观察任务进度

**验证点**:
- ✅ 任务立即创建
- ✅ 自动跳转到"生成任务"Tab
- ✅ 任务状态显示"运行中"
- ✅ 进度实时更新（0% → 100%）
- ✅ 显示当前步骤和已生成样本数
- ✅ 任务完成后显示成功通知

### 测试4: 查看新创建的样本集

1. 关闭生成弹窗
2. 点击"刷新"按钮
3. 应该看到新创建的样本集

**验证点**:
- ✅ 样本集列表增加了一条记录
- ✅ 样本集名称格式：[数据集名] - [时间戳]
- ✅ 状态显示"已完成"
- ✅ 样本数正确显示
- ✅ 训练集/验证集/测试集数量正确

### 测试5: 查看样本集的样本

1. 点击某个样本集的"查看样本"按钮
2. 进入样本列表视图

**验证点**:
- ✅ 面包屑显示完整路径
- ✅ 显示样本集统计信息卡片
- ✅ 表格显示该样本集的所有样本
- ✅ 每个样本显示ID、问题、类型、划分、时间
- ✅ 有"返回样本集"和"刷新"按钮

### 测试6: 查看样本详情

1. 在样本列表中，点击某个样本的"查看"按钮
2. 弹出样本详情弹窗

**验证点**:
- ✅ 显示样本ID
- ✅ 显示问题类型（标签）
- ✅ 显示数据集划分（标签）
- ✅ 显示完整的问题内容
- ✅ 显示完整的答案内容
- ✅ 显示源记录ID
- ✅ 显示生成时间

### 测试7: 删除单个样本

1. 在样本列表中，点击某个样本的"删除"按钮
2. 确认删除
3. 样本从列表中消失

**验证点**:
- ✅ 显示确认对话框
- ✅ 删除成功提示
- ✅ 样本从列表中移除
- ✅ 总数减少

### 测试8: 批量删除样本

1. 在样本列表中，勾选多个样本
2. 点击"批量删除"按钮
3. 确认删除

**验证点**:
- ✅ 显示选中数量
- ✅ 显示批量删除按钮
- ✅ 确认对话框显示删除数量
- ✅ 删除成功提示
- ✅ 所有选中样本被删除

### 测试9: 返回导航

1. 在样本列表视图，点击"返回样本集"
2. 应该返回到样本集列表
3. 点击"返回"按钮
4. 应该返回到数据集选择界面

**验证点**:
- ✅ 返回按钮正常工作
- ✅ 面包屑导航可点击
- ✅ 状态正确恢复

### 测试10: 删除样本集

1. 在样本集列表中，点击某个样本集的"删除"按钮
2. 确认删除

**验证点**:
- ✅ 显示警告：删除样本集将同时删除其包含的所有样本
- ✅ 删除成功提示
- ✅ 样本集从列表中移除
- ✅ 统计数据更新

### 测试11: 批量删除样本集

1. 在样本集列表中，勾选多个样本集
2. 点击"批量删除"按钮
3. 确认删除

**验证点**:
- ✅ 显示选中数量
- ✅ 显示批量删除按钮
- ✅ 确认对话框显示删除数量和警告
- ✅ 删除成功提示（显示删除的样本集数和样本数）
- ✅ 所有选中样本集被删除

### 测试12: 生成多个样本集

1. 重复测试3，生成第二个样本集
2. 使用不同的参数（如不同的LLM提供商）
3. 再次生成第三个样本集

**验证点**:
- ✅ 可以为同一数据集生成多个样本集
- ✅ 每个样本集独立存在
- ✅ 样本集名称包含时间戳，不会重复
- ✅ 统计数据正确累加

## 🔍 API测试

### 测试API端点

```bash
# 1. 获取数据集的样本集列表
curl http://localhost:8000/api/v1/sample-sets/dataset/1 \
  -H "Authorization: Bearer {token}"

# 2. 获取样本集详情
curl http://localhost:8000/api/v1/sample-sets/1 \
  -H "Authorization: Bearer {token}"

# 3. 获取样本集的样本列表
curl http://localhost:8000/api/v1/sample-sets/1/samples?limit=10 \
  -H "Authorization: Bearer {token}"

# 4. 获取样本集统计信息
curl http://localhost:8000/api/v1/sample-sets/1/stats \
  -H "Authorization: Bearer {token}"

# 5. 删除样本集
curl -X DELETE http://localhost:8000/api/v1/sample-sets/1 \
  -H "Authorization: Bearer {token}"

# 6. 批量删除样本集
curl -X POST http://localhost:8000/api/v1/sample-sets/batch-delete \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"sample_set_ids": [1, 2, 3]}'
```

## ⚠️ 常见问题

### 问题1: 迁移脚本报错

**错误**: `table sample_sets already exists`

**解决**: 表已存在，跳过迁移或删除表后重新迁移

```bash
# 删除表（谨慎！）
sqlite3 mvp/data/bank_code.db "DROP TABLE IF EXISTS sample_sets;"
# 重新运行迁移
python mvp/migrate_add_sample_sets.py
```

### 问题2: 前端看不到新功能

**原因**: 浏览器缓存

**解决**: 硬刷新浏览器
- Mac: `Command + Shift + R`
- Windows: `Ctrl + Shift + R`

### 问题3: 样本集列表为空

**原因**: 还没有生成过样本集

**解决**: 点击"生成样本"按钮创建第一个样本集

### 问题4: 生成任务失败

**检查**:
1. 后端日志：`mvp/logs/app_*.log`
2. 数据库连接是否正常
3. LLM API配置是否正确（如果使用API）

**建议**: 先使用`local`提供商测试

## 📊 测试数据建议

### 小规模测试（快速验证）

```
数据集: 任意数据集
记录数: 10条
LLM提供商: local
问题类型: exact, fuzzy
预计时间: < 1分钟
```

### 中等规模测试（功能验证）

```
数据集: 任意数据集
记录数: 100条
LLM提供商: qwen 或 deepseek
问题类型: exact, fuzzy, reverse
预计时间: 5-10分钟
```

### 大规模测试（性能验证）

```
数据集: 任意数据集
记录数: 1000条
LLM提供商: qwen
问题类型: exact, fuzzy, reverse, natural
预计时间: 30-60分钟
```

## ✅ 测试检查清单

- [ ] 数据库迁移成功
- [ ] 后端服务正常启动
- [ ] 前端页面正常加载
- [ ] 数据集选择功能正常
- [ ] 样本集列表显示正常
- [ ] 样本生成功能正常
- [ ] 异步任务进度更新正常
- [ ] 样本集创建成功
- [ ] 样本列表显示正常
- [ ] 样本详情查看正常
- [ ] 单个删除功能正常
- [ ] 批量删除功能正常
- [ ] 导航返回功能正常
- [ ] 面包屑导航正常
- [ ] 统计数据正确
- [ ] API端点响应正常

## 🎉 测试完成

如果所有测试都通过，恭喜！三层样本管理结构已经成功实现并可以正常使用了。

---

**测试时间**: 2026-02-01  
**预计测试时长**: 30-45分钟
