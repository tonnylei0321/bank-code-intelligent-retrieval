# ✅ 样本生成完整修复和测试指南

## 修复内容总结

### 1. 数据库迁移 ✅
- 添加`sample_sets`表
- 在`qa_pairs`表添加`sample_set_id`列
- 创建必要的索引

### 2. 代码修复 ✅
- 修复`sample_generation_async.py`中的`split_dataset`调用
- 创建`split_sample_set`函数专门处理样本集划分
- 支持规则生成和LLM生成两种方式
- 修复批量删除的权限验证问题

### 3. 测试脚本 ✅
- `test_complete_generation.py` - 完整生成流程测试
- `test_batch_delete.py` - 批量删除测试
- `test_rule_generation.py` - 规则生成测试

## 必须执行的步骤

### 步骤1: 确认数据库迁移已完成

```bash
cd mvp
python migrate_add_sample_sets.py
```

**预期输出**:
```
✅ 数据库迁移完成！
✓ sample_sets表创建成功
✓ qa_pairs.sample_set_id列添加成功
```

### 步骤2: 重启后端服务 ⚠️ 重要!

**方法1: 如果使用终端运行**
1. 找到运行uvicorn的终端
2. 按 `Ctrl+C` 停止服务
3. 重新启动:
```bash
cd mvp
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --log-level info
```

**方法2: 如果使用后台进程**
```bash
# 查找进程ID
ps aux | grep "uvicorn.*app.main" | grep -v grep

# 停止进程 (替换PID为实际进程ID)
kill <PID>

# 重新启动
cd mvp
nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --log-level info > backend.log 2>&1 &
```

**为什么必须重启?**
- Python会缓存已加载的模块
- 修改代码后必须重启才能生效
- 否则会继续运行旧代码

### 步骤3: 清除浏览器缓存

在浏览器中:
- Mac: `Cmd+Shift+R`
- Windows: `Ctrl+Shift+R`

### 步骤4: 运行测试验证

```bash
python test_complete_generation.py
```

## 测试流程

### 自动化测试

```bash
# 完整生成测试
python test_complete_generation.py

# 批量删除测试
python test_batch_delete.py

# 规则生成测试
python test_rule_generation.py
```

### 手动测试

1. **登录系统**
   - 用户名: admin
   - 密码: admin123

2. **进入样本生成页面**
   - 选择数据集
   - 选择生成方式: "规则生成"
   - 选择问题类型: "精确查询"、"模糊查询"
   - 记录数策略: "自定义数量" → 输入 5
   - 点击"开始生成样本"

3. **查看生成任务**
   - 自动跳转到"生成任务"Tab
   - 查看任务进度
   - 等待任务完成

4. **验证结果**
   - 进入"样本管理"页面
   - 选择数据集
   - 查看新生成的样本集
   - 点击样本集查看样本详情

5. **测试批量删除**
   - 勾选多个样本集
   - 点击"批量删除"
   - 确认删除
   - 验证删除成功

## 预期结果

### 规则生成

**任务日志应该显示**:
```
[21:43:29] 任务开始执行
[21:43:29] 数据集: xxx.unl, 记录数: 100
[21:43:29] 创建样本集: xxx - 20260201_214329 (ID: 1)
[21:43:29] 使用规则生成器
[21:43:30] 已处理 5/5 条记录，生成 10 个样本
[21:43:30] 成功生成 10 个样本
[21:43:30] 任务完成！
[21:43:30] 训练集: 8, 验证集: 1, 测试集: 1
```

**样本内容示例**:
```
问题: 中国工商银行北京西单支行的联行号是什么？
答案: 中国工商银行北京西单支行的相关信息如下：
      联行号：102100099996
```

### 批量删除

**成功响应**:
```json
{
  "message": "成功删除 2 个样本集",
  "deleted_sample_sets": 2,
  "deleted_samples": 20
}
```

## 常见问题排查

### Q1: 仍然报错 "split_dataset() got an unexpected keyword argument"

**原因**: 后端服务没有重启,还在运行旧代码

**解决**:
1. 停止后端服务
2. 重新启动后端服务
3. 等待服务完全启动(看到 "Application startup complete")
4. 再次测试

### Q2: 报错 "no such column: qa_pairs.sample_set_id"

**原因**: 数据库迁移没有执行

**解决**:
```bash
cd mvp
python migrate_add_sample_sets.py
```

### Q3: 生成任务一直pending

**原因**: 后台任务可能卡住了

**解决**:
1. 检查后端日志: `tail -f mvp/logs/error_2026-02-01.log`
2. 重启后端服务
3. 重新提交任务

### Q4: 前端显示旧数据

**原因**: 浏览器缓存

**解决**: 硬刷新浏览器 (Cmd+Shift+R 或 Ctrl+Shift+R)

## 验证清单

在提交给用户验证前,确认以下所有项:

- [ ] 数据库迁移已执行
- [ ] 后端服务已重启
- [ ] 测试脚本运行成功
- [ ] 规则生成功能正常
- [ ] 样本集正确创建
- [ ] 样本正确划分(训练/验证/测试)
- [ ] 批量删除功能正常
- [ ] 错误日志无新错误
- [ ] 前端页面显示正常

## 测试命令快速参考

```bash
# 1. 数据库迁移
cd mvp && python migrate_add_sample_sets.py

# 2. 重启后端 (先停止当前服务)
cd mvp
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --log-level info

# 3. 运行测试
python test_complete_generation.py

# 4. 查看日志
tail -f mvp/logs/error_2026-02-01.log
```

## 文件清单

### 修改的文件
- `mvp/app/api/sample_generation_async.py` - 修复split调用
- `mvp/app/api/sample_sets.py` - 修复权限验证

### 新增的文件
- `test_complete_generation.py` - 完整测试脚本
- `test_batch_delete.py` - 批量删除测试
- `test_rule_generation.py` - 规则生成测试
- `✅样本生成完整修复和测试指南.md` - 本文档

### 已存在的文件
- `mvp/migrate_add_sample_sets.py` - 数据库迁移脚本

## 下一步

1. **执行所有必须步骤**
2. **运行测试脚本验证**
3. **确认所有测试通过**
4. **提交给用户验证**

## 测试结果记录

### 测试环境
- 操作系统: macOS
- Python版本: 3.9
- 数据库: SQLite

### 测试时间
- 日期: 2026-02-01
- 时间: 待测试

### 测试结果
- [ ] 数据库迁移: 
- [ ] 规则生成: 
- [ ] 批量删除: 
- [ ] 前端显示: 

---

**重要提示**: 在提交给用户前,必须完成所有测试并确认通过!
